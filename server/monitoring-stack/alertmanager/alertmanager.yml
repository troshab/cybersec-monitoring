# =============================================================================
# Alertmanager Configuration
# =============================================================================
# Cybersec Monitoring Stack
# –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü—ñ—è —Å–ø–æ–≤—ñ—â–µ–Ω—å –Ω–∞ email, Pushover
#
# DEMO: –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è Mailpit (localhost:1025) - –≤—Å—ñ –ª–∏—Å—Ç–∏ –≤–∏–¥–Ω–æ –Ω–∞ :8025
# PRODUCTION: –ó–∞–º—ñ–Ω—ñ—Ç—å –Ω–∞ —Å–ø—Ä–∞–≤–∂–Ω—ñ–π SMTP —Å–µ—Ä–≤–µ—Ä
# =============================================================================

global:
  # Email –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è (Mailpit –¥–ª—è –¥–µ–º–æ)
  smtp_smarthost: 'mailpit:1025'
  smtp_from: 'monitoring@lab.local'
  smtp_require_tls: false
  # –î–ª—è production –∑ –∞–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—î—é —Ä–æ–∑–∫–æ–º–µ–Ω—Ç—É–π—Ç–µ:
  # smtp_auth_username: '${SMTP_AUTH_USERNAME}'
  # smtp_auth_password: '${SMTP_AUTH_PASSWORD}'

  # Resolve timeout
  resolve_timeout: 5m

# =============================================================================
# –®–∞–±–ª–æ–Ω–∏ –¥–ª—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å
# =============================================================================
templates:
  - '/etc/alertmanager/templates/*.tmpl'

# =============================================================================
# –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü—ñ—è –∞–ª–µ—Ä—Ç—ñ–≤
# =============================================================================
route:
  # –ü–æ–ª—è –¥–ª—è –≥—Ä—É–ø—É–≤–∞–Ω–Ω—è –∞–ª–µ—Ä—Ç—ñ–≤
  group_by: ['alertname', 'severity', 'instance']

  # –ß–∞—Å –æ—á—ñ–∫—É–≤–∞–Ω–Ω—è –ø–µ—Ä–µ–¥ –≤—ñ–¥–ø—Ä–∞–≤–∫–æ—é –≥—Ä—É–ø–∏
  group_wait: 30s

  # –Ü–Ω—Ç–µ—Ä–≤–∞–ª –º—ñ–∂ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è–º–∏ –¥–ª—è –æ–¥–Ω—ñ—î—ó –≥—Ä—É–ø–∏
  group_interval: 5m

  # –Ü–Ω—Ç–µ—Ä–≤–∞–ª –ø–æ–≤—Ç–æ—Ä–Ω–æ—ó –≤—ñ–¥–ø—Ä–∞–≤–∫–∏
  repeat_interval: 4h

  # –û—Ç—Ä–∏–º—É–≤–∞—á –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º
  receiver: 'email-critical'

  # –î–æ—á—ñ—Ä–Ω—ñ –º–∞—Ä—à—Ä—É—Ç–∏
  routes:
    # -------------------------------------------------------------------------
    # CRITICAL - –Ω–µ–≥–∞–π–Ω–µ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è –≤—Å—ñ–º–∞ –∫–∞–Ω–∞–ª–∞–º–∏
    # -------------------------------------------------------------------------
    - match:
        severity: critical
      receiver: 'critical-all-channels'
      group_wait: 10s
      repeat_interval: 1h
      continue: false

    # -------------------------------------------------------------------------
    # HIGH - email + pushover
    # -------------------------------------------------------------------------
    - match:
        severity: high
      receiver: 'email-high'
      group_wait: 1m
      repeat_interval: 2h
      continue: false

    # -------------------------------------------------------------------------
    # Infrastructure alerts - –æ–∫—Ä–µ–º–∏–π –∫–∞–Ω–∞–ª
    # -------------------------------------------------------------------------
    - match:
        category: infrastructure
      receiver: 'email-infrastructure'
      group_wait: 30s
      repeat_interval: 1h
      continue: false

    # -------------------------------------------------------------------------
    # Security alerts - —Ç–µ—Ä–º—ñ–Ω–æ–≤–æ
    # -------------------------------------------------------------------------
    - match:
        category: security
      receiver: 'critical-all-channels'
      group_wait: 10s
      repeat_interval: 30m
      continue: false

    # -------------------------------------------------------------------------
    # Warning - —Ç—ñ–ª—å–∫–∏ email
    # -------------------------------------------------------------------------
    - match:
        severity: warning
      receiver: 'email-warning'
      group_wait: 5m
      repeat_interval: 12h
      continue: false

# =============================================================================
# –û—Ç—Ä–∏–º—É–≤–∞—á—ñ (receivers)
# =============================================================================
receivers:
  # ---------------------------------------------------------------------------
  # Email –¥–ª—è –∫—Ä–∏—Ç–∏—á–Ω–∏—Ö –∞–ª–µ—Ä—Ç—ñ–≤
  # ---------------------------------------------------------------------------
  - name: 'email-critical'
    email_configs:
      - to: 'admin@lab.local'
        send_resolved: true
        headers:
          Subject: 'üî¥ CRITICAL: {{ .GroupLabels.alertname }}'
        html: |
          <h2>üî¥ –ö—Ä–∏—Ç–∏—á–Ω–∏–π –∞–ª–µ—Ä—Ç!</h2>
          <p><strong>–ê–ª–µ—Ä—Ç:</strong> {{ .GroupLabels.alertname }}</p>
          <p><strong>–ß–∞—Å:</strong> {{ .StartsAt.Format "2006-01-02 15:04:05" }}</p>
          {{ range .Alerts }}
          <hr>
          <p><strong>Instance:</strong> {{ .Labels.instance }}</p>
          <p><strong>–û–ø–∏—Å:</strong> {{ .Annotations.description }}</p>
          <p><strong>Severity:</strong> {{ .Labels.severity }}</p>
          {{ end }}
          <hr>
          <p><a href="http://${MONITORING_SERVER_IP}:3000">–í—ñ–¥–∫—Ä–∏—Ç–∏ Grafana</a></p>

  # ---------------------------------------------------------------------------
  # Email –¥–ª—è high severity
  # ---------------------------------------------------------------------------
  - name: 'email-high'
    email_configs:
      - to: 'admin@lab.local'
        send_resolved: true
        headers:
          Subject: 'üü† HIGH: {{ .GroupLabels.alertname }}'

  # ---------------------------------------------------------------------------
  # Email –¥–ª—è warning
  # ---------------------------------------------------------------------------
  - name: 'email-warning'
    email_configs:
      - to: 'admin@lab.local'
        send_resolved: true
        headers:
          Subject: 'üü° Warning: {{ .GroupLabels.alertname }}'

  # ---------------------------------------------------------------------------
  # Email –¥–ª—è infrastructure
  # ---------------------------------------------------------------------------
  - name: 'email-infrastructure'
    email_configs:
      - to: 'admin@lab.local'
        send_resolved: true
        headers:
          Subject: 'üîß Infrastructure: {{ .GroupLabels.alertname }}'

  # ---------------------------------------------------------------------------
  # –í—Å—ñ –∫–∞–Ω–∞–ª–∏ –¥–ª—è –∫—Ä–∏—Ç–∏—á–Ω–∏—Ö –∞–ª–µ—Ä—Ç—ñ–≤
  # ---------------------------------------------------------------------------
  - name: 'critical-all-channels'
    email_configs:
      - to: 'admin@lab.local'
        send_resolved: true
        headers:
          Subject: 'üö® CRITICAL SECURITY: {{ .GroupLabels.alertname }}'

    # Pushover (–º–æ–±—ñ–ª—å–Ω—ñ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è) - —Ä–æ–∑–∫–æ–º–µ–Ω—Ç—É–π—Ç–µ —è–∫—â–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç–µ
    # pushover_configs:
    #   - user_key: '${PUSHOVER_USER_KEY}'
    #     token: '${PUSHOVER_API_TOKEN}'
    #     priority: 1
    #     title: 'üö® {{ .GroupLabels.alertname }}'
    #     message: '{{ range .Alerts }}{{ .Annotations.summary }}{{ end }}'
    #     send_resolved: true

    # Webhook - –¥–ª—è —ñ–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—ó –∑ —ñ–Ω—à–∏–º–∏ —Å–∏—Å—Ç–µ–º–∞–º–∏ (SIEM, ticketing, etc.)
    # webhook_configs:
    #   - url: 'http://your-webhook-endpoint/alert'
    #     send_resolved: true

  # ---------------------------------------------------------------------------
  # Null receiver (–¥–ª—è —ñ–≥–Ω–æ—Ä—É–≤–∞–Ω–Ω—è –ø–µ–≤–Ω–∏—Ö –∞–ª–µ—Ä—Ç—ñ–≤)
  # ---------------------------------------------------------------------------
  - name: 'null'

# =============================================================================
# Inhibition rules - –ø—Ä–∏–¥—É—à–µ–Ω–Ω—è –∞–ª–µ—Ä—Ç—ñ–≤
# =============================================================================
inhibit_rules:
  # –Ø–∫—â–æ –∫—Ä–∏—Ç–∏—á–Ω–∏–π –∞–ª–µ—Ä—Ç - –ø—Ä–∏–¥—É—à–∏—Ç–∏ warning –¥–ª—è —Ç–æ–≥–æ –∂ instance
  - source_match:
      severity: 'critical'
    target_match:
      severity: 'warning'
    equal: ['alertname', 'instance']

  # –Ø–∫—â–æ —Å–µ—Ä–≤–µ—Ä down - –Ω–µ —Å–ª–∞—Ç–∏ –∞–ª–µ—Ä—Ç–∏ –ø—Ä–æ –π–æ–≥–æ —Å–µ—Ä–≤—ñ—Å–∏
  - source_match:
      alertname: 'EndpointDown'
    target_match_re:
      alertname: '.*High.*|.*Low.*'
    equal: ['instance']

  # –Ø–∫—â–æ –º–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥ down - –Ω–µ —Å–ª–∞—Ç–∏ –Ω—ñ—á–æ–≥–æ
  - source_match:
      alertname: 'PrometheusDown'
    target_match_re:
      alertname: '.*'
    equal: []
