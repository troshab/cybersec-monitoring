# =============================================================================
# Promtail Configuration - Monitoring Server
# =============================================================================
# Збір логів з самого сервера моніторингу + Syslog від мережевого обладнання
# =============================================================================

server:
  http_listen_port: 9080
  grpc_listen_port: 0
  log_level: info

positions:
  filename: /var/lib/promtail/positions.yaml

clients:
  - url: http://localhost:3100/loki/api/v1/push
    batchwait: 1s
    batchsize: 1048576
    timeout: 10s

# =============================================================================
# Scrape Configs
# =============================================================================
scrape_configs:
  # ---------------------------------------------------------------------------
  # System logs (auth, syslog, kern)
  # ---------------------------------------------------------------------------
  - job_name: linux_auth
    static_configs:
      - targets:
          - localhost
        labels:
          job: linux_auth
          host: monitoring-server
          __path__: /var/log/auth.log

  - job_name: linux_syslog
    static_configs:
      - targets:
          - localhost
        labels:
          job: linux_syslog
          host: monitoring-server
          __path__: /var/log/syslog

  - job_name: linux_kern
    static_configs:
      - targets:
          - localhost
        labels:
          job: linux_kern
          host: monitoring-server
          __path__: /var/log/kern.log

  # ---------------------------------------------------------------------------
  # Docker container logs
  # ---------------------------------------------------------------------------
  - job_name: docker_containers
    static_configs:
      - targets:
          - localhost
        labels:
          job: docker
          host: monitoring-server
          __path__: /var/lib/docker/containers/*/*.log
    pipeline_stages:
      - json:
          expressions:
            log: log
            stream: stream
            time: time
      - labels:
          stream:
      - output:
          source: log

  # ---------------------------------------------------------------------------
  # Fail2ban logs
  # ---------------------------------------------------------------------------
  - job_name: fail2ban
    static_configs:
      - targets:
          - localhost
        labels:
          job: fail2ban
          host: monitoring-server
          __path__: /var/log/fail2ban.log
    pipeline_stages:
      - regex:
          expression: '.*\[(?P<jail>\w+)\].*(?P<action>Ban|Unban).*(?P<ip>\d+\.\d+\.\d+\.\d+)'
      - labels:
          jail:
          action:
          ip:

  # ---------------------------------------------------------------------------
  # UFW Firewall logs
  # ---------------------------------------------------------------------------
  - job_name: ufw
    static_configs:
      - targets:
          - localhost
        labels:
          job: ufw
          host: monitoring-server
          __path__: /var/log/ufw.log
    pipeline_stages:
      - regex:
          expression: '.*\[UFW (?P<action>\w+)\].*SRC=(?P<src_ip>\d+\.\d+\.\d+\.\d+).*DST=(?P<dst_ip>\d+\.\d+\.\d+\.\d+).*PROTO=(?P<proto>\w+)'
      - labels:
          action:
          src_ip:
          proto:

  # ---------------------------------------------------------------------------
  # Syslog від мережевого обладнання (UDP 514)
  # ---------------------------------------------------------------------------
  - job_name: network_syslog
    syslog:
      listen_address: 0.0.0.0:514
      listen_protocol: udp
      idle_timeout: 60s
      label_structured_data: true
      labels:
        job: network_syslog
    relabel_configs:
      - source_labels: ['__syslog_message_hostname']
        target_label: 'host'
      - source_labels: ['__syslog_message_severity']
        target_label: 'severity'
      - source_labels: ['__syslog_message_facility']
        target_label: 'facility'
      - source_labels: ['__syslog_message_app_name']
        target_label: 'app'
    pipeline_stages:
      # Визначення типу пристрою по hostname pattern
      - match:
          selector: '{job="network_syslog"}'
          stages:
            - regex:
                expression: '(?i)(?P<device_type>switch|router|fw|firewall|ap|wap)'
            - labels:
                device_type:

      # Виявлення login/logout подій
      - match:
          selector: '{job="network_syslog"}'
          stages:
            - regex:
                expression: '(?i)(?P<auth_event>login|logout|authentication|failed|success)'
            - labels:
                auth_event:

      # Виявлення config changes
      - match:
          selector: '{job="network_syslog"}'
          stages:
            - regex:
                expression: '(?i)(?P<config_event>config|changed|modified|saved|loaded)'
            - labels:
                config_event:

  # ---------------------------------------------------------------------------
  # Syslog TCP (для пристроїв що не підтримують UDP)
  # ---------------------------------------------------------------------------
  - job_name: network_syslog_tcp
    syslog:
      listen_address: 0.0.0.0:1514
      listen_protocol: tcp
      idle_timeout: 120s
      label_structured_data: true
      labels:
        job: network_syslog_tcp
    relabel_configs:
      - source_labels: ['__syslog_message_hostname']
        target_label: 'host'
      - source_labels: ['__syslog_message_severity']
        target_label: 'severity'
