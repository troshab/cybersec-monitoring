# =============================================================================
# Inventory Stack - Docker Compose
# =============================================================================
# Netdisco (мережева інвентаризація) + FleetDM (endpoints інвентаризація)
# Stack 2025: MySQL 8.4 LTS, Redis 7.4, FleetDM 4.61
# Based on: https://github.com/netdisco/netdisco-docker
# =============================================================================

# Netdisco common environment variables
# Ref: https://docs.docker.com/compose/how-tos/environment-variables/envvars-precedence/
x-netdisco-env: &netdisco-env
  NETDISCO_DOMAIN: '${NETDISCO_DOMAIN:-lab.local}'
  NETDISCO_DB_TENANT:
  NETDISCO_DB_NAME:
  NETDISCO_DB_HOST: '${NETDISCO_DB_HOST:-netdisco-postgresql}'
  NETDISCO_DB_PORT:
  NETDISCO_DB_USER:
  NETDISCO_DB_PASS:
  NETDISCO_RO_COMMUNITY:
  PGDATABASE:
  PGHOST:
  PGPORT:
  PGUSER:
  PGPASSWORD:
  # PostgreSQL version for upgrades (must match installed version)
  NETDISCO_CURRENT_PG_VERSION: '${NETDISCO_CURRENT_PG_VERSION:-18}'

services:
  # ===========================================================================
  # NETDISCO - Автоматична інвентаризація мережі
  # ===========================================================================

  # ---------------------------------------------------------------------------
  # PostgreSQL для Netdisco (офіційний образ netdisco)
  # Ref: https://github.com/netdisco/netdisco-docker
  # ---------------------------------------------------------------------------
  netdisco-postgresql:
    container_name: netdisco-postgresql
    image: netdisco/netdisco:latest-postgresql
    shm_size: 128mb
    hostname: netdisco-postgresql
    restart: unless-stopped
    # !! healthcheck is defined in the Dockerfile
    volumes:
      - "./netdisco/postgresql:/var/lib/postgresql"
    environment:
      <<: *netdisco-env
      NETDISCO_DB_SUPERUSER:
    networks:
      - inventory

  # ---------------------------------------------------------------------------
  # Ініціалізація бази даних Netdisco
  # Ref: https://github.com/netdisco/netdisco-docker
  # ---------------------------------------------------------------------------
  netdisco-db-init:
    container_name: netdisco-db-init
    image: netdisco/netdisco:latest-backend
    entrypoint: ''
    command: "/home/netdisco/bin/netdisco-env /home/netdisco/bin/netdisco-updatedb.sh"
    user: postgres
    depends_on:
      netdisco-postgresql:
        condition: service_healthy
    volumes:
      # Volume for PostgreSQL 13 upgrade path (legacy)
      - "./netdisco/pgdata:/var/lib/pgversions/pg13"
      # Volume for current PostgreSQL
      - "./netdisco/postgresql:/var/lib/pgversions/new"
      # Configuration directory (deployment.yml location)
      - "./netdisco/config:/home/netdisco/environments"
    environment:
      <<: *netdisco-env
      DEPLOY_ADMIN_USER: '${DEPLOY_ADMIN_USER:-YES}'
      NETDISCO_ADMIN_USER: ${NETDISCO_ADMIN_USER:-monadmin}
    networks:
      - inventory

  # ---------------------------------------------------------------------------
  # Netdisco Backend - збирач даних (poller daemon)
  # Ref: https://github.com/netdisco/netdisco-docker
  # ---------------------------------------------------------------------------
  netdisco-backend:
    image: netdisco/netdisco:latest-backend
    container_name: netdisco-backend
    hostname: netdisco-backend
    restart: unless-stopped
    # Use init process for proper signal handling
    init: true
    depends_on:
      netdisco-db-init:
        condition: service_completed_successfully
    volumes:
      # Local plugins and customizations
      - ./netdisco/nd-site-local:/home/netdisco/nd-site-local
      # Configuration (deployment.yml)
      - ./netdisco/config:/home/netdisco/environments
      # Logs directory
      - ./netdisco/logs:/home/netdisco/logs
    environment:
      <<: *netdisco-env
    # DNS options to prevent delays in device discovery
    dns_opt:
      - 'ndots:0'
      - 'timeout:1'
      - 'retries:0'
      - 'attempts:1'
      - edns0
      - trustad
    networks:
      - inventory

  # ---------------------------------------------------------------------------
  # Netdisco Web - інтерфейс
  # Ref: https://github.com/netdisco/netdisco-docker
  # ---------------------------------------------------------------------------
  netdisco-web:
    image: netdisco/netdisco:latest-web
    container_name: netdisco-web
    hostname: netdisco-web
    restart: unless-stopped
    # Use init process for proper signal handling
    init: true
    depends_on:
      netdisco-db-init:
        condition: service_completed_successfully
    ports:
      - "${NETDISCO_PORT:-5000}:5000"
    volumes:
      # Local plugins and customizations
      - ./netdisco/nd-site-local:/home/netdisco/nd-site-local
      # Configuration (deployment.yml)
      - ./netdisco/config:/home/netdisco/environments
      # Logs directory
      - ./netdisco/logs:/home/netdisco/logs
    environment:
      <<: *netdisco-env
      IPV: '${IPV:-4}'
      PORT:
    # DNS options to prevent delays
    dns_opt:
      - 'ndots:0'
      - 'timeout:1'
      - 'retries:0'
      - 'attempts:1'
      - edns0
      - trustad
    networks:
      - inventory

  # ===========================================================================
  # FLEETDM - Інвентаризація endpoints через osquery
  # ===========================================================================

  # ---------------------------------------------------------------------------
  # MySQL для FleetDM
  # ---------------------------------------------------------------------------
  fleet-mysql:
    image: mysql:8.4
    container_name: fleet-mysql
    restart: unless-stopped
    command: >
      --mysql-native-password=ON
      --gtid-mode=ON
      --enforce-gtid-consistency=ON
    environment:
      MYSQL_ROOT_PASSWORD: ${FLEET_MYSQL_ROOT_PASSWORD:-fleet_root_password}
      MYSQL_DATABASE: fleet
      MYSQL_USER: fleet
      MYSQL_PASSWORD: ${FLEET_MYSQL_PASSWORD:-fleet_user_password}
    volumes:
      - fleet-mysql-data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${FLEET_MYSQL_ROOT_PASSWORD:-fleet_root_password}"]
      interval: 10s
      timeout: 5s
      retries: 10
    networks:
      - inventory

  # ---------------------------------------------------------------------------
  # Redis для FleetDM
  # ---------------------------------------------------------------------------
  fleet-redis:
    image: redis:7.4-alpine
    container_name: fleet-redis
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - inventory

  # ---------------------------------------------------------------------------
  # FleetDM Server
  # ---------------------------------------------------------------------------
  fleet:
    image: fleetdm/fleet:v4.61.0
    container_name: fleet-server
    restart: unless-stopped
    depends_on:
      fleet-mysql:
        condition: service_healthy
      fleet-redis:
        condition: service_healthy
    command: sh -c "/usr/bin/fleet prepare db --no-prompt && /usr/bin/fleet serve"
    ports:
      - "${FLEET_PORT:-8080}:8080"
    volumes:
      - ./fleetdm/certs:/certs:ro
      - ./fleetdm/logs:/logs
    environment:
      FLEET_MYSQL_ADDRESS: fleet-mysql:3306
      FLEET_MYSQL_DATABASE: fleet
      FLEET_MYSQL_USERNAME: fleet
      FLEET_MYSQL_PASSWORD: ${FLEET_MYSQL_PASSWORD:-fleet_user_password}
      FLEET_REDIS_ADDRESS: fleet-redis:6379
      FLEET_SERVER_ADDRESS: 0.0.0.0:8080
      FLEET_SERVER_CERT: /certs/fleet.crt
      FLEET_SERVER_KEY: /certs/fleet.key
      FLEET_SERVER_PRIVATE_KEY: ${FLEET_SERVER_PRIVATE_KEY}
      FLEET_LOGGING_JSON: "true"
      FLEET_OSQUERY_STATUS_LOG_PLUGIN: filesystem
      FLEET_OSQUERY_RESULT_LOG_PLUGIN: filesystem
      FLEET_FILESYSTEM_STATUS_LOG_FILE: /logs/osqueryd.status.log
      FLEET_FILESYSTEM_RESULT_LOG_FILE: /logs/osqueryd.results.log
    networks:
      - inventory

# =============================================================================
# Volumes
# =============================================================================
volumes:
  fleet-mysql-data:
    driver: local

# =============================================================================
# Networks
# =============================================================================
networks:
  inventory:
    driver: bridge
