# =============================================================================
# Inventory Stack - Docker Compose
# =============================================================================
# Netdisco (мережева інвентаризація) + FleetDM (endpoints інвентаризація)
# Stack 2025: MySQL 8.4 LTS, Redis 7.4, FleetDM 4.61
# Based on: https://github.com/netdisco/netdisco-docker
# =============================================================================

# Netdisco common environment variables
# Ref: https://github.com/netdisco/netdisco/wiki/Environment-Variables
x-netdisco-env: &netdisco-env
  NETDISCO_DOMAIN: 'lab.local'
  NETDISCO_DB_HOST: netdisco-postgresql
  NETDISCO_DB_USER: netdisco
  NETDISCO_DB_PASS: ${NETDISCO_DB_PASSWORD:-netdisco_secure_password}
  # SNMP community strings (comma-separated for multiple)
  NETDISCO_RO_COMMUNITY: ${SNMP_COMMUNITY:-public}
  # PostgreSQL version for upgrades (must match installed version)
  NETDISCO_CURRENT_PG_VERSION: ${NETDISCO_CURRENT_PG_VERSION:-17}

services:
  # ===========================================================================
  # NETDISCO - Автоматична інвентаризація мережі
  # ===========================================================================

  # ---------------------------------------------------------------------------
  # PostgreSQL для Netdisco (офіційний образ netdisco)
  # Ref: https://github.com/netdisco/netdisco-docker
  # ---------------------------------------------------------------------------
  netdisco-postgresql:
    image: netdisco/netdisco:latest-postgresql
    container_name: netdisco-postgresql
    hostname: netdisco-postgresql
    restart: unless-stopped
    # Shared memory for PostgreSQL - required for proper operation
    shm_size: 128mb
    volumes:
      # Official path for PostgreSQL data
      - ./netdisco/pgdata:/var/lib/postgresql
    environment:
      <<: *netdisco-env
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U netdisco -d netdisco || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s
    networks:
      - inventory

  # ---------------------------------------------------------------------------
  # Ініціалізація бази даних Netdisco
  # Ref: https://github.com/netdisco/netdisco-docker
  # ---------------------------------------------------------------------------
  netdisco-db-init:
    image: netdisco/netdisco:latest-backend
    container_name: netdisco-db-init
    # Override entrypoint to run DB initialization
    entrypoint: ''
    command: "/home/netdisco/bin/netdisco-env /home/netdisco/bin/netdisco-updatedb.sh"
    user: postgres
    depends_on:
      netdisco-postgresql:
        condition: service_healthy
    volumes:
      # Volume for PostgreSQL upgrade path (same as postgresql service)
      - ./netdisco/pgdata:/var/lib/pgversions/new
      # Configuration directory (deployment.yml location)
      - ./netdisco/config:/home/netdisco/environments
    environment:
      <<: *netdisco-env
      # Deploy admin user on first run
      DEPLOY_ADMIN_USER: 'YES'
      NETDISCO_ADMIN_USER: ${NETDISCO_ADMIN_USER:-monadmin}
      NETDISCO_ADMIN_PASS: ${NETDISCO_ADMIN_PASS:-}
    networks:
      - inventory

  # ---------------------------------------------------------------------------
  # Netdisco Backend - збирач даних (poller daemon)
  # Ref: https://github.com/netdisco/netdisco-docker
  # ---------------------------------------------------------------------------
  netdisco-backend:
    image: netdisco/netdisco:latest-backend
    container_name: netdisco-backend
    hostname: netdisco-backend
    restart: unless-stopped
    # Use init process for proper signal handling
    init: true
    depends_on:
      netdisco-db-init:
        condition: service_completed_successfully
    volumes:
      # Local plugins and customizations
      - ./netdisco/nd-site-local:/home/netdisco/nd-site-local
      # Configuration (deployment.yml)
      - ./netdisco/config:/home/netdisco/environments
      # Logs directory
      - ./netdisco/logs:/home/netdisco/logs
    environment:
      <<: *netdisco-env
    # DNS options to prevent delays in device discovery
    dns_opt:
      - 'ndots:0'
      - 'timeout:1'
      - 'retries:0'
      - 'attempts:1'
      - edns0
      - trustad
    networks:
      - inventory

  # ---------------------------------------------------------------------------
  # Netdisco Web - інтерфейс
  # Ref: https://github.com/netdisco/netdisco-docker
  # ---------------------------------------------------------------------------
  netdisco-web:
    image: netdisco/netdisco:latest-web
    container_name: netdisco-web
    hostname: netdisco-web
    restart: unless-stopped
    # Use init process for proper signal handling
    init: true
    depends_on:
      netdisco-db-init:
        condition: service_completed_successfully
    ports:
      - "${NETDISCO_PORT:-5000}:5000"
    volumes:
      # Local plugins and customizations
      - ./netdisco/nd-site-local:/home/netdisco/nd-site-local
      # Configuration (deployment.yml)
      - ./netdisco/config:/home/netdisco/environments
      # Logs directory
      - ./netdisco/logs:/home/netdisco/logs
    environment:
      <<: *netdisco-env
      # IPv4 only (set to '6' for IPv6, or remove for both)
      IPV: '4'
      # Use deployment configuration
      DANCER_ENVIRONMENT: deployment
    # DNS options to prevent delays
    dns_opt:
      - 'ndots:0'
      - 'timeout:1'
      - 'retries:0'
      - 'attempts:1'
      - edns0
      - trustad
    networks:
      - inventory

  # ===========================================================================
  # FLEETDM - Інвентаризація endpoints через osquery
  # ===========================================================================

  # ---------------------------------------------------------------------------
  # MySQL для FleetDM
  # ---------------------------------------------------------------------------
  fleet-mysql:
    image: mysql:8.4
    container_name: fleet-mysql
    restart: unless-stopped
    command: >
      --mysql-native-password=ON
      --gtid-mode=ON
      --enforce-gtid-consistency=ON
    environment:
      MYSQL_ROOT_PASSWORD: ${FLEET_MYSQL_ROOT_PASSWORD:-fleet_root_password}
      MYSQL_DATABASE: fleet
      MYSQL_USER: fleet
      MYSQL_PASSWORD: ${FLEET_MYSQL_PASSWORD:-fleet_user_password}
    volumes:
      - fleet-mysql-data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${FLEET_MYSQL_ROOT_PASSWORD:-fleet_root_password}"]
      interval: 10s
      timeout: 5s
      retries: 10
    networks:
      - inventory

  # ---------------------------------------------------------------------------
  # Redis для FleetDM
  # ---------------------------------------------------------------------------
  fleet-redis:
    image: redis:7.4-alpine
    container_name: fleet-redis
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - inventory

  # ---------------------------------------------------------------------------
  # FleetDM Server
  # ---------------------------------------------------------------------------
  fleet:
    image: fleetdm/fleet:v4.61.0
    container_name: fleet-server
    restart: unless-stopped
    depends_on:
      fleet-mysql:
        condition: service_healthy
      fleet-redis:
        condition: service_healthy
    command: sh -c "/usr/bin/fleet prepare db --no-prompt && /usr/bin/fleet serve"
    ports:
      - "${FLEET_PORT:-8080}:8080"
    volumes:
      - ./fleetdm/certs:/certs:ro
      - fleet-logs:/logs
    environment:
      FLEET_MYSQL_ADDRESS: fleet-mysql:3306
      FLEET_MYSQL_DATABASE: fleet
      FLEET_MYSQL_USERNAME: fleet
      FLEET_MYSQL_PASSWORD: ${FLEET_MYSQL_PASSWORD:-fleet_user_password}
      FLEET_REDIS_ADDRESS: fleet-redis:6379
      FLEET_SERVER_ADDRESS: 0.0.0.0:8080
      FLEET_SERVER_CERT: /certs/fleet.crt
      FLEET_SERVER_KEY: /certs/fleet.key
      FLEET_SERVER_PRIVATE_KEY: ${FLEET_SERVER_PRIVATE_KEY}
      FLEET_LOGGING_JSON: "true"
      FLEET_OSQUERY_STATUS_LOG_PLUGIN: filesystem
      FLEET_OSQUERY_RESULT_LOG_PLUGIN: filesystem
      FLEET_FILESYSTEM_STATUS_LOG_FILE: /logs/osqueryd.status.log
      FLEET_FILESYSTEM_RESULT_LOG_FILE: /logs/osqueryd.results.log
    networks:
      - inventory

# =============================================================================
# Volumes
# =============================================================================
volumes:
  fleet-mysql-data:
    driver: local
  fleet-logs:
    driver: local

# =============================================================================
# Networks
# =============================================================================
networks:
  inventory:
    driver: bridge
