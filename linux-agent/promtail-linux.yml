# Promtail Configuration for Linux Systems
# Підтримує: Ubuntu, Debian, RHEL, CentOS, Kali
# Generated for cybersec-monitoring project

server:
  http_listen_port: 9080
  grpc_listen_port: 0

positions:
  filename: /var/lib/promtail/positions.yaml

clients:
  - url: ${LOKI_URL}/loki/api/v1/push
    batchwait: 1s
    batchsize: 1048576
    timeout: 10s

scrape_configs:
  # =========================================================================
  # Syslog (General System Logs)
  # =========================================================================
  - job_name: syslog
    static_configs:
      - targets:
          - localhost
        labels:
          job: syslog
          host: ${HOSTNAME}
          os_type: linux
          __path__: /var/log/syslog
    pipeline_stages:
      - regex:
          expression: '^(?P<timestamp>\w+\s+\d+\s+\d+:\d+:\d+)\s+(?P<hostname>\S+)\s+(?P<process>[^\[:\s]+)(?:\[(?P<pid>\d+)\])?:\s+(?P<message>.*)$'
      - labels:
          process:
      - timestamp:
          source: timestamp
          format: "Jan _2 15:04:05"

  # =========================================================================
  # Messages (RHEL/CentOS)
  # =========================================================================
  - job_name: messages
    static_configs:
      - targets:
          - localhost
        labels:
          job: messages
          host: ${HOSTNAME}
          os_type: linux
          __path__: /var/log/messages
    pipeline_stages:
      - regex:
          expression: '^(?P<timestamp>\w+\s+\d+\s+\d+:\d+:\d+)\s+(?P<hostname>\S+)\s+(?P<process>[^\[:\s]+)(?:\[(?P<pid>\d+)\])?:\s+(?P<message>.*)$'
      - labels:
          process:

  # =========================================================================
  # Authentication Logs (Critical for Security)
  # =========================================================================
  - job_name: auth
    static_configs:
      - targets:
          - localhost
        labels:
          job: auth
          host: ${HOSTNAME}
          os_type: linux
          category: authentication
          severity: high
          __path__: /var/log/auth.log
    pipeline_stages:
      - regex:
          expression: '^(?P<timestamp>\w+\s+\d+\s+\d+:\d+:\d+)\s+(?P<hostname>\S+)\s+(?P<process>[^\[:\s]+)(?:\[(?P<pid>\d+)\])?:\s+(?P<message>.*)$'
      - labels:
          process:
      # Detect failed logins
      - match:
          selector: '{job="auth"}'
          stages:
            - regex:
                expression: '(?i)(failed|invalid|error|denied|attack|illegal)'
                source: message
            - labels:
                alert_type: auth_failure

  # =========================================================================
  # Secure Log (RHEL/CentOS Authentication)
  # =========================================================================
  - job_name: secure
    static_configs:
      - targets:
          - localhost
        labels:
          job: secure
          host: ${HOSTNAME}
          os_type: linux
          category: authentication
          severity: high
          __path__: /var/log/secure
    pipeline_stages:
      - regex:
          expression: '^(?P<timestamp>\w+\s+\d+\s+\d+:\d+:\d+)\s+(?P<hostname>\S+)\s+(?P<process>[^\[:\s]+)(?:\[(?P<pid>\d+)\])?:\s+(?P<message>.*)$'
      - labels:
          process:
      - match:
          selector: '{job="secure"}'
          stages:
            - regex:
                expression: '(?i)(failed|invalid|error|denied)'
                source: message
            - labels:
                alert_type: auth_failure

  # =========================================================================
  # Audit Logs (Auditd)
  # =========================================================================
  - job_name: audit
    static_configs:
      - targets:
          - localhost
        labels:
          job: audit
          host: ${HOSTNAME}
          os_type: linux
          category: audit
          severity: high
          __path__: /var/log/audit/audit.log
    pipeline_stages:
      - regex:
          expression: 'type=(?P<audit_type>\w+)\s+msg=audit\((?P<timestamp>\d+\.\d+):(?P<serial>\d+)\):\s*(?P<message>.*)'
      - labels:
          audit_type:
      # Critical audit events
      - match:
          selector: '{audit_type=~"EXECVE|USER_CMD|USER_AUTH|USER_LOGIN|USER_LOGOUT|USER_START|USER_END|CRED_ACQ|CRED_DISP"}'
          stages:
            - static_labels:
                severity: critical
      # User/Group changes
      - match:
          selector: '{audit_type=~"ADD_USER|DEL_USER|ADD_GROUP|DEL_GROUP|CHGRP_ID|GRP_MGMT|USER_MGMT"}'
          stages:
            - static_labels:
                severity: critical
                category: account_management
      # Privilege escalation
      - match:
          selector: '{audit_type=~"USER_CMD"}'
          stages:
            - regex:
                expression: 'cmd=(?P<command>[^\s]+)'
                source: message
            - labels:
                command:

  # =========================================================================
  # SSH Daemon Logs
  # =========================================================================
  - job_name: sshd
    journal:
      labels:
        job: sshd
        host: ${HOSTNAME}
        os_type: linux
        category: ssh
        severity: high
      path: /var/log/journal
    relabel_configs:
      - source_labels: ['__journal__systemd_unit']
        regex: 'sshd.service'
        action: keep
    pipeline_stages:
      - regex:
          expression: '(?P<action>Accepted|Failed|Invalid|Disconnected).*?(?P<method>password|publickey)?.*?for\s+(?P<user>\S+)\s+from\s+(?P<source_ip>[\d\.]+)'
      - labels:
          action:
          user:
          source_ip:
      - match:
          selector: '{action="Failed"}'
          stages:
            - static_labels:
                alert_type: ssh_brute_force

  # =========================================================================
  # Sudo Commands (Privilege Escalation)
  # =========================================================================
  - job_name: sudo
    static_configs:
      - targets:
          - localhost
        labels:
          job: sudo
          host: ${HOSTNAME}
          os_type: linux
          category: privilege_escalation
          severity: critical
          __path__: /var/log/auth.log
    pipeline_stages:
      - match:
          selector: '{job="sudo"}'
          stages:
            - regex:
                expression: 'sudo'
                source: filename
      - regex:
          expression: '(?P<user>\S+)\s+:\s+TTY=(?P<tty>\S+)\s+;\s+PWD=(?P<pwd>[^;]+)\s+;\s+USER=(?P<target_user>\S+)\s+;\s+COMMAND=(?P<command>.+)$'
      - labels:
          user:
          target_user:
          command:

  # =========================================================================
  # Kernel Messages
  # =========================================================================
  - job_name: kern
    static_configs:
      - targets:
          - localhost
        labels:
          job: kern
          host: ${HOSTNAME}
          os_type: linux
          category: kernel
          __path__: /var/log/kern.log
    pipeline_stages:
      - regex:
          expression: '^(?P<timestamp>\w+\s+\d+\s+\d+:\d+:\d+)\s+(?P<hostname>\S+)\s+kernel:\s+\[\s*(?P<uptime>[\d\.]+)\]\s+(?P<message>.*)$'
      - labels:
          uptime:
      # Detect kernel security events
      - match:
          selector: '{job="kern"}'
          stages:
            - regex:
                expression: '(?i)(segfault|oom|panic|bug|warning|error)'
                source: message
            - labels:
                kernel_event:

  # =========================================================================
  # Cron Jobs
  # =========================================================================
  - job_name: cron
    static_configs:
      - targets:
          - localhost
        labels:
          job: cron
          host: ${HOSTNAME}
          os_type: linux
          category: scheduled_tasks
          __path__: /var/log/cron.log
    pipeline_stages:
      - regex:
          expression: '^\((?P<user>\S+)\)\s+CMD\s+\((?P<command>.*)\)$'
      - labels:
          user:

  # =========================================================================
  # Package Management (Debian/Ubuntu)
  # =========================================================================
  - job_name: dpkg
    static_configs:
      - targets:
          - localhost
        labels:
          job: dpkg
          host: ${HOSTNAME}
          os_type: linux
          category: packages
          __path__: /var/log/dpkg.log
    pipeline_stages:
      - regex:
          expression: '(?P<timestamp>\d{4}-\d{2}-\d{2}\s+\d{2}:\d{2}:\d{2})\s+(?P<action>\S+)\s+(?P<package>\S+)\s+(?P<version>\S+)'
      - labels:
          action:
          package:

  # =========================================================================
  # Package Management (RHEL/CentOS - DNF)
  # =========================================================================
  - job_name: dnf
    static_configs:
      - targets:
          - localhost
        labels:
          job: dnf
          host: ${HOSTNAME}
          os_type: linux
          category: packages
          __path__: /var/log/dnf.log
    pipeline_stages:
      - regex:
          expression: '(?P<timestamp>\w+\s+\d+\s+\d+:\d+:\d+)\s+(?P<action>SUBDEBUG|DEBUG|INFO|WARNING|ERROR)\s+(?P<message>.*)'
      - labels:
          action:

  # =========================================================================
  # UFW Firewall (Ubuntu)
  # =========================================================================
  - job_name: ufw
    static_configs:
      - targets:
          - localhost
        labels:
          job: ufw
          host: ${HOSTNAME}
          os_type: linux
          category: firewall
          __path__: /var/log/ufw.log
    pipeline_stages:
      - regex:
          expression: '\[UFW\s+(?P<action>BLOCK|ALLOW|AUDIT)\]\s+IN=(?P<interface>\S*)\s+OUT=.*SRC=(?P<src_ip>[\d\.]+)\s+DST=(?P<dst_ip>[\d\.]+).*PROTO=(?P<proto>\S+).*DPT=(?P<dst_port>\d+)?'
      - labels:
          action:
          src_ip:
          proto:
          dst_port:

  # =========================================================================
  # Fail2ban (If installed)
  # =========================================================================
  - job_name: fail2ban
    static_configs:
      - targets:
          - localhost
        labels:
          job: fail2ban
          host: ${HOSTNAME}
          os_type: linux
          category: intrusion_prevention
          severity: high
          __path__: /var/log/fail2ban.log
    pipeline_stages:
      - regex:
          expression: '(?P<timestamp>\d{4}-\d{2}-\d{2}\s+\d{2}:\d{2}:\d{2},\d+)\s+fail2ban\.(?P<component>\S+)\s*\[(?P<pid>\d+)\]:\s+(?P<level>\S+)\s+\[(?P<jail>\S+)\]\s+(?P<action>Ban|Unban|Found)?\s*(?P<ip>[\d\.]+)?'
      - labels:
          component:
          level:
          jail:
          action:
          ip:
      - match:
          selector: '{action="Ban"}'
          stages:
            - static_labels:
                alert_type: ip_banned

  # =========================================================================
  # Apache/Nginx Access Logs (If web server)
  # =========================================================================
  - job_name: apache_access
    static_configs:
      - targets:
          - localhost
        labels:
          job: apache_access
          host: ${HOSTNAME}
          os_type: linux
          category: webserver
          __path__: /var/log/apache2/access.log
    pipeline_stages:
      - regex:
          expression: '^(?P<remote_addr>[\d\.]+)\s+-\s+(?P<remote_user>\S+)\s+\[(?P<timestamp>[^\]]+)\]\s+"(?P<method>\S+)\s+(?P<path>\S+)\s+(?P<protocol>[^"]+)"\s+(?P<status>\d+)\s+(?P<bytes>\d+)'
      - labels:
          method:
          status:
      # Detect attacks
      - match:
          selector: '{status=~"4..|5.."}'
          stages:
            - static_labels:
                alert_type: http_error

  - job_name: nginx_access
    static_configs:
      - targets:
          - localhost
        labels:
          job: nginx_access
          host: ${HOSTNAME}
          os_type: linux
          category: webserver
          __path__: /var/log/nginx/access.log
    pipeline_stages:
      - regex:
          expression: '^(?P<remote_addr>[\d\.]+)\s+-\s+(?P<remote_user>\S+)\s+\[(?P<timestamp>[^\]]+)\]\s+"(?P<method>\S+)\s+(?P<path>\S+)\s+(?P<protocol>[^"]+)"\s+(?P<status>\d+)\s+(?P<bytes>\d+)'
      - labels:
          method:
          status:

  # =========================================================================
  # Systemd Journal (Catch-all)
  # =========================================================================
  - job_name: journal
    journal:
      labels:
        job: journal
        host: ${HOSTNAME}
        os_type: linux
      path: /var/log/journal
      max_age: 12h
    relabel_configs:
      - source_labels: ['__journal_priority']
        target_label: 'priority'
      - source_labels: ['__journal__systemd_unit']
        target_label: 'unit'
      - source_labels: ['__journal_syslog_identifier']
        target_label: 'syslog_identifier'
    pipeline_stages:
      # Only keep priority 0-4 (emergency to warning)
      - match:
          selector: '{priority=~"[0-4]"}'
          stages:
            - static_labels:
                severity: high
