# Promtail Configuration for Windows 11 Client
# Оптимізовано для робочих станцій
# Generated for cybersec-monitoring project

server:
  http_listen_port: 9080
  grpc_listen_port: 0

positions:
  filename: C:\ProgramData\Promtail\positions.yaml

clients:
  - url: ${LOKI_URL}/loki/api/v1/push
    batchwait: 1s
    batchsize: 1048576
    timeout: 10s

scrape_configs:
  # =========================================================================
  # Security Events - Authentication (High Priority)
  # =========================================================================
  - job_name: win11_auth
    windows_events:
      use_incoming_timestamp: true
      bookmark_path: C:\ProgramData\Promtail\auth-bookmark.xml
      eventlog_name: Security
      xpath_query: |
        Event[System[(
          EventID=4624 or EventID=4625 or EventID=4634 or EventID=4647 or
          EventID=4648 or EventID=4672 or EventID=4776 or EventID=4740
        )]]
    relabel_configs:
      - source_labels: ['computer']
        target_label: 'host'
      - source_labels: ['channel']
        target_label: 'log_channel'
    pipeline_stages:
      - json:
          expressions:
            event_id: eventID
            user: targetUserName
            logon_type: logonType
            source_ip: ipAddress
      - labels:
          event_id:
          logon_type:
    labels:
      job: windows_auth
      host: ${HOSTNAME}
      os_type: windows11
      category: authentication
      severity: high

  # =========================================================================
  # Security Events - Account Management
  # =========================================================================
  - job_name: win11_accounts
    windows_events:
      use_incoming_timestamp: true
      bookmark_path: C:\ProgramData\Promtail\accounts-bookmark.xml
      eventlog_name: Security
      xpath_query: |
        Event[System[(
          EventID=4720 or EventID=4722 or EventID=4723 or EventID=4724 or
          EventID=4725 or EventID=4726 or EventID=4727 or EventID=4728 or
          EventID=4729 or EventID=4730 or EventID=4731 or EventID=4732 or
          EventID=4733 or EventID=4734 or EventID=4735 or EventID=4738
        )]]
    labels:
      job: windows_accounts
      host: ${HOSTNAME}
      os_type: windows11
      category: account_management
      severity: critical

  # =========================================================================
  # Security Events - Process Creation (4688)
  # =========================================================================
  - job_name: win11_process
    windows_events:
      use_incoming_timestamp: true
      bookmark_path: C:\ProgramData\Promtail\process-bookmark.xml
      eventlog_name: Security
      xpath_query: |
        Event[System[EventID=4688]]
    pipeline_stages:
      - json:
          expressions:
            process_name: newProcessName
            command_line: commandLine
            parent_process: parentProcessName
      - labels:
          process_name:
    labels:
      job: windows_process
      host: ${HOSTNAME}
      os_type: windows11
      category: process_creation
      severity: medium

  # =========================================================================
  # Security Events - Scheduled Tasks & Services
  # =========================================================================
  - job_name: win11_persistence
    windows_events:
      use_incoming_timestamp: true
      bookmark_path: C:\ProgramData\Promtail\persistence-bookmark.xml
      eventlog_name: Security
      xpath_query: |
        Event[System[(
          EventID=4697 or EventID=4698 or EventID=4699 or
          EventID=4700 or EventID=4701 or EventID=4702
        )]]
    labels:
      job: windows_persistence
      host: ${HOSTNAME}
      os_type: windows11
      category: persistence
      severity: critical

  # =========================================================================
  # Security Events - Audit/Policy Changes (Critical for defense evasion detection)
  # 1100, 1102 - Audit log shutdown/cleared
  # 4703 - Token right adjusted
  # 4704, 4705 - User right assigned/removed
  # 4719 - Audit policy changed
  # =========================================================================
  - job_name: win11_policy
    windows_events:
      use_incoming_timestamp: true
      bookmark_path: C:\ProgramData\Promtail\policy-bookmark.xml
      eventlog_name: Security
      xpath_query: |
        Event[System[(
          EventID=1100 or EventID=1102 or
          EventID=4703 or EventID=4704 or EventID=4705 or EventID=4719
        )]]
    labels:
      job: windows_policy
      host: ${HOSTNAME}
      os_type: windows11
      category: policy_changes
      severity: critical

  # =========================================================================
  # System Events - Services
  # =========================================================================
  - job_name: win11_services
    windows_events:
      use_incoming_timestamp: true
      bookmark_path: C:\ProgramData\Promtail\services-bookmark.xml
      eventlog_name: System
      xpath_query: |
        Event[System[(
          EventID=7045 or EventID=7040 or EventID=7034 or EventID=7036
        )]]
    labels:
      job: windows_services
      host: ${HOSTNAME}
      os_type: windows11
      category: services
      severity: high

  # =========================================================================
  # PowerShell Script Block Logging
  # =========================================================================
  - job_name: win11_powershell
    windows_events:
      use_incoming_timestamp: true
      bookmark_path: C:\ProgramData\Promtail\powershell-bookmark.xml
      eventlog_name: Microsoft-Windows-PowerShell/Operational
      xpath_query: |
        Event[System[(EventID=4103 or EventID=4104)]]
    pipeline_stages:
      - json:
          expressions:
            script_block: scriptBlockText
      - match:
          selector: '{job="win11_powershell"}'
          stages:
            - regex:
                expression: '(?i)(invoke-mimikatz|invoke-expression|downloadstring|bypass|hidden|encoded)'
                source: script_block
            - metrics:
                suspicious_powershell:
                  type: Counter
                  description: "Suspicious PowerShell commands detected"
                  source: script_block
                  config:
                    match_all: true
                    action: inc
    labels:
      job: windows_powershell
      host: ${HOSTNAME}
      os_type: windows11
      category: powershell
      severity: critical

  # =========================================================================
  # Sysmon Events
  # =========================================================================
  - job_name: win11_sysmon
    windows_events:
      use_incoming_timestamp: true
      bookmark_path: C:\ProgramData\Promtail\sysmon-bookmark.xml
      eventlog_name: Microsoft-Windows-Sysmon/Operational
      xpath_query: |
        Event[System[(
          EventID=1 or EventID=3 or EventID=5 or EventID=7 or
          EventID=8 or EventID=10 or EventID=11 or EventID=12 or
          EventID=13 or EventID=15 or EventID=17 or EventID=18 or
          EventID=22 or EventID=23 or EventID=25
        )]]
    pipeline_stages:
      - json:
          expressions:
            event_id: eventID
            image: image
            target_filename: targetFilename
            destination_ip: destinationIp
            query_name: queryName
      - labels:
          event_id:
    labels:
      job: windows_sysmon
      host: ${HOSTNAME}
      os_type: windows11
      category: sysmon
      severity: high

  # =========================================================================
  # Windows Defender Events
  # =========================================================================
  - job_name: win11_defender
    windows_events:
      use_incoming_timestamp: true
      bookmark_path: C:\ProgramData\Promtail\defender-bookmark.xml
      eventlog_name: Microsoft-Windows-Windows Defender/Operational
      xpath_query: |
        Event[System[(
          EventID=1006 or EventID=1007 or EventID=1008 or EventID=1009 or
          EventID=1116 or EventID=1117 or EventID=1118 or EventID=1119 or
          EventID=5001 or EventID=5007 or EventID=5010 or EventID=5012
        )]]
    labels:
      job: windows_defender
      host: ${HOSTNAME}
      os_type: windows11
      category: antivirus
      severity: high

  # =========================================================================
  # Application Errors & Crashes
  # =========================================================================
  - job_name: win11_application
    windows_events:
      use_incoming_timestamp: true
      bookmark_path: C:\ProgramData\Promtail\application-bookmark.xml
      eventlog_name: Application
      xpath_query: |
        Event[System[(Level=1 or Level=2)]]
    labels:
      job: windows_application
      host: ${HOSTNAME}
      os_type: windows11
      category: application
      severity: medium

  # =========================================================================
  # Windows Firewall Events
  # =========================================================================
  - job_name: win11_firewall
    windows_events:
      use_incoming_timestamp: true
      bookmark_path: C:\ProgramData\Promtail\firewall-bookmark.xml
      eventlog_name: Microsoft-Windows-Windows Firewall With Advanced Security/Firewall
      xpath_query: |
        Event[System[(EventID=2003 or EventID=2004 or EventID=2005 or EventID=2006)]]
    labels:
      job: windows_firewall
      host: ${HOSTNAME}
      os_type: windows11
      category: firewall
      severity: medium

  # =========================================================================
  # RDP/Terminal Services (Client perspective)
  # =========================================================================
  - job_name: win11_rdp
    windows_events:
      use_incoming_timestamp: true
      bookmark_path: C:\ProgramData\Promtail\rdp-bookmark.xml
      eventlog_name: Microsoft-Windows-TerminalServices-LocalSessionManager/Operational
      xpath_query: |
        Event[System[(EventID=21 or EventID=22 or EventID=23 or EventID=24 or EventID=25)]]
    labels:
      job: windows_rdp
      host: ${HOSTNAME}
      os_type: windows11
      category: remote_access
      severity: high
